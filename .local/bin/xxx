#!/usr/bin/env perl

use strict;
use warnings;
use File::Basename;
use feature 'say';

our $encext = "1937";

sub prpl {
    my ($text) = @_;
    return "\033[35m" . $text . "\033[0m";
}

sub goahead {
    my $input = <STDIN>;

    chomp($input);
    $input =~ s/^\s+|\s+$//g;
    $input = lc($input);
    return $input =~ /^(y|yes|yas)$/ ? 1 : 0;
}

sub xxxdir {
    my ($path) = @_;
    my $dirname = basename($path);
    my $parent = dirname($path);
    my $output = "$dirname.tar.gz.$encext";

    print "encrypt dir " . prpl($path) . " -> " . prpl($output) . " [y/N] ";
    return unless goahead();

    `tar czf - -C '$parent' '$dirname' | openssl enc -aes-256-cbc -salt -pbkdf2 -out '$output'`;
    die "dir encrypt error\n" unless $? == 0;

    # print prpl(`realpath $output`);
}

sub xxxfile {
    my $output;
    my ($path) = @_;
    my $basename = basename($path);
    my $is_encrypted = $path =~ /\.$encext$/;

    if ($is_encrypted) {

        $output = $basename;
        $output =~ s/\.$encext$//;

        print "decrypt file " . prpl($path) . " -> " . prpl($output) . " [y/N] ";
        return unless goahead();

        `openssl enc -aes-256-cbc -d -salt -pbkdf2 -in '$path' -out '$output'`;
        die "file decrypt error\n" unless $? == 0;

        if ($output =~ /\.tar\.gz$/) {
            print "unzip archive " . prpl($output) . " [y/N] ";
            return unless goahead();

            `tar xzf '$output' -C .`;
            die "unzip archive error\n" unless $? == 0;
            unlink $output;
        }
    } else {
        $output = "$basename.$encext";
        print "encrypt file " . prpl($path) . " -> " . prpl($output) . " [y/N] ";
        return unless goahead();

        `openssl enc -aes-256-cbc -salt -pbkdf2 -in '$path' -out '$output'`;
        die "encrypt file error\n" unless $? == 0;
    }

    # print prpl(`realpath $output`);
}

sub xxx {
    my ($arg) = @_;
    if (-f $arg) {
        xxxfile($arg);
    } elsif (-d $arg) {
        xxxdir($arg);
    } else {
        die prpl($arg) . " is not a file or dir\n";
    }
}

if (@ARGV < 1) {
    say prpl('xxx ') . '- simple encrypt/decrypt (aes256) openssl wrapper';
    say 'usage: xxx ' . prpl('path');
} else {
    foreach my $arg (@ARGV) {
        xxx($arg);
    }
    say prpl("bye bye :*")
}
