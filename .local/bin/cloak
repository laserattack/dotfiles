#!/usr/bin/env perl

use strict;
use warnings;
use File::Basename;
use feature 'say';

sub goahead {
    my $input = <STDIN>;
    chomp($input);
    $input =~ s/^\s+|\s+$//g;
    $input = lc($input);
    return $input =~ /^(y|yes|yas)$/ ? 1 : 0;
}

sub cloakdir {
    my ($path) = @_;
    my $output = basename($path).".tar.gz.enc";
    print "Encrypt dir '$path' (-> $output)? [y/N] ";
    return unless goahead();
    `tar czf - '$path' | openssl enc -aes-256-cbc -salt -pbkdf2 -out '$output'`;
    die "[ERROR] dir encrypt error" unless $? == 0;
}

sub cloakfile {
    my ($path) = @_;
    my ($name, undef, $suffix) = fileparse($path, qr/\.[^.]*$/);
    if ($suffix =~ /^\.enc$/) {
        `openssl enc -aes-256-cbc -d -salt -pbkdf2 -in $path -out $name`
        die "[ERROR] file decrypt error" unless $? == 0;
    } else {
        say "enc";
    }
}

sub cloak {
    my ($arg) = @_;
    if (-f $arg) {
        cloakfile($arg);
    } elsif (-d $arg) {
        cloakdir($arg);
    } else {
        die "[ERROR] '$arg' is not a file or dir\n";
    }
}

if (@ARGV < 1) {
    say 'cloak <porno path>';
} else {
    foreach my $arg (@ARGV) {
        cloak($arg);
    }
    say 'Everything all right. bye bye!'
}
